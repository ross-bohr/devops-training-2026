name: helm-to-k8s-demo

on:
  workflow_dispatch:

env:
  DOCKERHUB_REPO: rossdocker123/simpleapi-demo-2026

  CHART_PATH: ./charts/demo

  K8S_NAMESPACE: demo
  HELM_RELEASRE: demo

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_REPO }}
          tags: |
            type=sha,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ./src
          file: ./src/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Resolve image tag for deployment
        id: img
        run: |
          # First tag emitted by metadata-action is sha-short
          TAG="$(echo '${{ steps.meta.outputs.tags }}' | head -n 1 | sed 's/.*://')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using image: ${{ env.DOCKERHUB_REPO }}:$TAG"

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.34.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Install kind
        run: |
          curl -Lo kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
          chmod +x kind
          sudo mv kind /usr/local/bin/kind
          kind version

      - name: Create cluster
        run: |
          kind create cluster --name ci
          kubectl get nodes

      - name: Deploy chart
        run: |
          kubectl create ns demo
          helm upgrade --install demo ./charts/demo -n demo
          kubectl get all -n demo
          # If you know the deployment name:
          kubectl rollout status deploy/demo-hello-web -n demo --timeout=180s

      - name: Smoke test (port-forward + curl)
        run: |
          # Replace svc name/port as appropriate for your chart
          kubectl -n demo port-forward svc/demo-hello-web 8080:80 >/tmp/pf.log 2>&1 &
          sleep 2
          curl -f http://127.0.0.1:8080/
